language: python
dist: trusty

addons:
  apt:
    sources:
      - google-chrome
    packages:
      - google-chrome-stable

python:
  - "2.7"

services:
  - mysql
  - docker

install:
  - pip install flake8==3.3.0
  - flake8 . --count --select=E901,E999,F821,F822,F823 --show-source --statistics
  - sudo rm /etc/apt/sources.list.d/docker.list
  # - sudo apt-get purge -y mysql-common mysql-server mysql-client
  # - nvm install v7.10.0
  # - wget https://raw.githubusercontent.com/frappe/bench/master/playbooks/install.py
  # - sudo python install.py --develop --user travis --without-bench-setup
  # - sudo pip install -e ~/bench

  # - rm $TRAVIS_BUILD_DIR/.git/shallow
  # - bash $TRAVIS_BUILD_DIR/travis/bench_init.sh
  - docker --version
  - docker pull vishaljsesh/erpnext-travis
  # - docker run -d -it --network=host --name erpnext-travis -p 8000:8000 -p 9000:9000 -p 6787:6787 --mount type=bind,source=$TRAVIS_BUILD_DIR,target=/home/frappe/erpnext vishaljsesh/erpnext-travis:latest
  # - docker run -d -it --network=host --name erpnext-travis -p 8000:8000 -p 9000:9000 -p 6787:6787 -v $TRAVIS_BUILD_DIR:/home/frappe/erpnext vishaljsesh/erpnext-travis:latest
  - docker run -d -it --name erpnext-travis -p 8000:8000 -p 9000:9000 -p 6787:6787 -v $TRAVIS_BUILD_DIR:/home/frappe/erpnext vishaljsesh/erpnext-travis:latest
before_script:
  - wget http://chromedriver.storage.googleapis.com/2.33/chromedriver_linux64.zip
  - unzip chromedriver_linux64.zip
  - sudo apt-get install libnss3
  - sudo apt-get --only-upgrade install google-chrome-stable
  - sudo cp chromedriver /usr/local/bin/.
  - sudo chmod +x /usr/local/bin/chromedriver
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - sleep 3
  - docker exec -i erpnext-travis bash -c "service mysql restart"
  # - docker exec -i erpnext-travis bash -c "service mysql restart"
  # - mysql -u root -proot -e 'create database test_frappe'
  # - echo "USE mysql;\nCREATE USER 'test_frappe'@'localhost' IDENTIFIED BY 'test_frappe';\nFLUSH PRIVILEGES;\n" | mysql -u root -proot
  # - echo "USE mysql;\nGRANT ALL PRIVILEGES ON \`test_frappe\`.* TO 'test_frappe'@'localhost';\n" | mysql -u root -proot
  # - PR_BRANCH_HEAD=$(docker exec -itu frappe erpnext-travis bash -c "cd ~/erpnext && echo $(git rev-parse HEAD)")
  - PR_BRANCH_HEAD=$(docker exec -itu frappe erpnext-travis bash -c "cd ~/erpnext && git rev-parse HEAD") 
  - docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench/apps/erpnext && git remote add test ~/erpnext/ && git fetch --unshallow test && git checkout -b test -t test/$TRAVIS_BRANCH"
  # - CURRENT_BRANCH_HEAD=$(docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench/apps/erpnext && echo git rev-parse HEAD")
  - CURRENT_BRANCH_HEAD=$(docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench/apps/erpnext && git rev-parse HEAD")
  - set -e
  - diff <( echo \"$PR_BRANCH_HEAD\" ) <( echo \"$CURRENT_BRANCH_HEAD\" )
  # - bench get-app erpnext $TRAVIS_BUILD_DIR
  - docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench use test_site"
  # - bench reinstall --yes
  - docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench migrate"
  - docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench build"
  - docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench scheduler disable"
  # - docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench start &"
  - docker exec -idu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench start"
  # - docker exec -itu frappe erpnext-travis bash -c "cd ~/frappe-bench && sleep 10"
  - sleep 10 
  - docker exec -it erpnext-travis bash -c "service xvfb restart"

jobs:
  include:
    - stage: test
      script:
        - docker exec -iu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench run-tests"
      env: Server Side Test
    - # stage
      script:
        - docker exec -iu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench --verbose run-setup-wizard-ui-test"
        - docker exec -iu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench execute erpnext.setup.utils.enable_all_roles_and_domains"
        - docker exec -iu frappe erpnext-travis bash -c "cd ~/frappe-bench && bench run-ui-tests --app erpnext"
      env: Client Side Test
    - # stage
      script:
        - bench --verbose run-setup-wizard-ui-test
        - bench execute erpnext.setup.utils.enable_all_roles_and_domains
        - bench run-ui-tests --app erpnext --test erpnext/agriculture/doctype/land_unit/test_land_unit.js
        - bench run-ui-tests --app erpnext --test erpnext/agriculture/doctype/fertilizer/test_fertilizer.js
        - bench run-ui-tests --app erpnext --test erpnext/agriculture/doctype/water_analysis/test_water_analysis.js
        - bench run-ui-tests --app erpnext --test erpnext/agriculture/doctype/disease/test_disease.js
        - bench run-ui-tests --app erpnext --test erpnext/agriculture/doctype/soil_texture/test_soil_texture.js
        - bench run-ui-tests --app erpnext --test erpnext/agriculture/doctype/crop/test_crop.js
        - bench run-ui-tests --app erpnext --test erpnext/agriculture/doctype/crop_cycle/test_crop_cycle.js
      env: Agriculture Client Side Test
    - # stage
      script:
        - wget http://build.erpnext.com/20171108_190013_955977f8_database.sql.gz
        - bench --force restore ~/frappe-bench/20171108_190013_955977f8_database.sql.gz --mariadb-root-password travis
        - bench migrate
      env: Patch Testing